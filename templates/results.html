{% extends "base.html" %}

{% block title %}Processing Results - Immigration Audit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="fas fa-chart-line"></i> Processing Results
                </h3>
                <span class="badge bg-success fs-6">
                    {{ results.segments_found or 1 }} Document(s) Processed
                </span>
            </div>
            <div class="card-body">
                <!-- Processing Summary -->
                {% set file_overview = results.processing_summary.file_overview if results.processing_summary.file_overview else None %}
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-file-alt fa-2x mb-2"></i>
                                <h4>{{ file_overview.total_pages if file_overview else 'N/A' }}</h4>
                                <p class="mb-0">Total Pages</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <h4>{{ file_overview.people_identified if file_overview else 0 }}</h4>
                                <p class="mb-0">People Identified</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <h4>{{ results.documents_processed|length or 1 }}</h4>
                                <p class="mb-0">Documents Found</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <h4>{{ results.processing_summary.red_flags|length or 0 }}</h4>
                                <p class="mb-0">Red Flags</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Red Flags -->
                {% if results.processing_summary.red_flags %}
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle"></i> Data Quality Alerts</h5>
                    <ul class="mb-0">
                        {% for flag in results.processing_summary.red_flags %}
                        <li>{{ flag }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Validation Errors -->
                {% if results.validation_errors %}
                <div class="alert alert-danger">
                    <h5><i class="fas fa-times-circle"></i> Processing Errors</h5>
                    <ul class="mb-0">
                        {% for error in results.validation_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Document Types Found -->
                {% if file_overview and file_overview.document_types_found %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Document Types Detected</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for doc_type, count in file_overview.document_types_found.items() %}
                            <div class="col-md-4 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>{{ doc_type }}</span>
                                    <span class="badge bg-secondary">{{ count }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Person Records -->
                {% if results.person_records %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Identified Individuals</h5>
                    </div>
                    <div class="card-body">
                        {% for person_key, person_data in results.person_records.items() %}
                        <div class="person-record mb-3 p-3 border rounded">
                            <h6 class="text-primary">
                                <i class="fas fa-user"></i> {{ person_data.name }}
                                {% if person_data.date_of_birth %}
                                <small class="text-muted">(DOB: {{ person_data.date_of_birth }})</small>
                                {% endif %}
                            </h6>

                            <!-- Documents for this person -->
                            <div class="mt-2">
                                <strong>Documents:</strong>
                                {% for doc in person_data.documents %}
                                <span class="badge bg-info me-1">{{ doc.type }}</span>
                                {% endfor %}
                            </div>

                            <!-- Timeline -->
                            {% if person_data.timeline %}
                            <div class="mt-2">
                                <strong>Timeline:</strong>
                                <div class="timeline-items">
                                    {% for event in person_data.timeline[:3] %}
                                    <small class="d-block">{{ event.date }}: {{ event.event }}</small>
                                    {% endfor %}
                                    {% if person_data.timeline|length > 3 %}
                                    <small class="text-muted">... and {{ person_data.timeline|length - 3 }} more</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Inconsistencies -->
                            {% if person_data.inconsistencies %}
                            <div class="mt-2">
                                <div class="alert alert-warning alert-sm mb-0">
                                    <small><strong>Data Inconsistencies:</strong></small>
                                    {% for inconsistency in person_data.inconsistencies %}
                                    <small class="d-block">â€¢ {{ inconsistency }}</small>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Recommendations -->
                {% if results.processing_summary.recommendations %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb"></i> Audit Recommendations
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            {% for recommendation in results.processing_summary.recommendations %}
                            <li>{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}

                <!-- Raw Extracted Data (Collapsible) -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <button class="btn btn-link text-decoration-none p-0" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#rawData">
                                <i class="fas fa-code"></i> Raw Extracted Data
                            </button>
                        </h5>
                    </div>
                    <div class="collapse" id="rawData">
                        <div class="card-body">
                            <pre class="bg-light p-3 rounded"><code>{{ results | tojson(indent=2) }}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-4 d-flex gap-2">
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Process Another Document
                    </a>
                    {% if results.processing_id %}
                    <a href="{{ url_for('audit_summary', result_id=results.processing_id) }}"
                       class="btn btn-primary">
                        <i class="fas fa-file-alt"></i> View Detailed Audit Report
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}